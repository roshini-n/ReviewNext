<div class="reviews-container">
  <div class="header-section">
    <h1>
      <mat-icon>rate_review</mat-icon>
      Review Management
    </h1>
    <p class="subtitle">Moderate and manage user reviews across all categories</p>
    
    <div class="header-actions">
      <button mat-raised-button color="primary" (click)="exportReviews()">
        <mat-icon>download</mat-icon>
        Export Reviews
      </button>
      <button mat-raised-button (click)="loadReviews()">
        <mat-icon>refresh</mat-icon>
        Refresh
      </button>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="filters-section">
    <mat-card>
      <mat-card-content>
        <div class="filters-container">
          <mat-form-field appearance="outline" class="search-field">
            <mat-label>Search reviews...</mat-label>
            <input
              matInput
              [(ngModel)]="searchQuery"
              (keyup.enter)="applyFilter()"
              placeholder="Search by username, review text, or content"
            >
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Category</mat-label>
            <mat-select [(ngModel)]="selectedCategory" (selectionChange)="applyFilter()">
              <mat-option *ngFor="let category of categories" [value]="category.value">
                {{ category.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Rating</mat-label>
            <mat-select [(ngModel)]="selectedRating" (selectionChange)="applyFilter()">
              <mat-option *ngFor="let rating of ratings" [value]="rating.value">
                {{ rating.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          
          <div class="filter-actions">
            <button mat-raised-button color="primary" (click)="applyFilter()">
              <mat-icon>filter_list</mat-icon>
              Apply
            </button>
            <button mat-button (click)="clearFilters()">
              <mat-icon>clear</mat-icon>
              Clear
            </button>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Loading reviews...</p>
  </div>

  <!-- Reviews Table -->
  <div *ngIf="!isLoading" class="table-section">
    <mat-card>
      <mat-card-header>
        <mat-card-title>
          <mat-icon>reviews</mat-icon>
          Reviews ({{ dataSource.data.length }})
        </mat-card-title>
      </mat-card-header>
      
      <mat-card-content>
        <div class="table-container">
          <table mat-table [dataSource]="dataSource" matSort class="reviews-table">
            
            <!-- Content Column -->
            <ng-container matColumnDef="content">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Content</th>
              <td mat-cell *matCellDef="let review">
                <div class="content-cell">
                  <mat-chip-set>
                    <mat-chip [color]="review.category === 'games' ? 'primary' : 'accent'" selected>
                      {{ review.category | titlecase }}
                    </mat-chip>
                  </mat-chip-set>
                  <span class="content-title">{{ review.contentTitle }}</span>
                </div>
              </td>
            </ng-container>

            <!-- User Column -->
            <ng-container matColumnDef="user">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>User</th>
              <td mat-cell *matCellDef="let review">
                <div class="user-cell">
                  <strong>{{ review.username }}</strong>
                </div>
              </td>
            </ng-container>

            <!-- Rating Column -->
            <ng-container matColumnDef="rating">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Rating</th>
              <td mat-cell *matCellDef="let review">
                <div class="rating-cell">
                  <div class="stars">
                    <mat-icon 
                      *ngFor="let star of getStarArray(review.rating)" 
                      [class.filled]="star <= review.rating"
                      class="star-icon">
                      star
                    </mat-icon>
                  </div>
                  <span class="rating-text">{{ review.rating }}/5</span>
                </div>
              </td>
            </ng-container>

            <!-- Review Text Column -->
            <ng-container matColumnDef="review">
              <th mat-header-cell *matHeaderCellDef>Review</th>
              <td mat-cell *matCellDef="let review">
                <div class="review-cell">
                  <span *ngIf="review.reviewText; else noReview" [title]="review.reviewText">
                    {{ review.reviewText }}
                  </span>
                  <ng-template #noReview>
                    <em class="no-review">Rating only</em>
                  </ng-template>
                </div>
              </td>
            </ng-container>

            <!-- Date Column -->
            <ng-container matColumnDef="date">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Date</th>
              <td mat-cell *matCellDef="let review">
                <div class="date-cell">
                  {{ review.datePosted | date:'short' }}
                </div>
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Actions</th>
              <td mat-cell *matCellDef="let review">
                <div class="actions-cell">
                  <button
                    mat-icon-button
                    color="accent"
                    (click)="editReview(review)"
                    matTooltip="Edit Review"
                  >
                    <mat-icon>edit</mat-icon>
                  </button>
                  
                  <button
                    mat-icon-button
                    color="warn"
                    (click)="flagReview(review)"
                    matTooltip="Flag Review"
                  >
                    <mat-icon>flag</mat-icon>
                  </button>
                  
                  <button
                    mat-icon-button
                    color="warn"
                    (click)="deleteReview(review)"
                    matTooltip="Delete Review"
                  >
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="review-row"></tr>
          </table>
        </div>

        <!-- Paginator -->
        <mat-paginator
          [pageSizeOptions]="[10, 25, 50, 100]"
          [pageSize]="25"
          showFirstLastButtons
        ></mat-paginator>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- No Reviews State -->
  <div *ngIf="!isLoading && dataSource.data.length === 0" class="no-reviews-container">
    <mat-card>
      <mat-card-content>
        <div class="no-reviews-content">
          <mat-icon class="no-reviews-icon">rate_review</mat-icon>
          <h3>No Reviews Found</h3>
          <p *ngIf="searchQuery || selectedCategory !== 'all' || selectedRating !== 'all'; else noReviewsAtAll">
            No reviews match your filter criteria. Try adjusting your filters.
          </p>
          <ng-template #noReviewsAtAll>
            <p>There are no reviews in the system yet.</p>
          </ng-template>
          <button mat-raised-button color="primary" (click)="clearFilters()" 
                  *ngIf="searchQuery || selectedCategory !== 'all' || selectedRating !== 'all'">
            Clear Filters
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>
